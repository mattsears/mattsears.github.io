<html class="h-full antialiased js-focus-visible" data-js-focus-visible="" style="--header-position: sticky; --content-offset: 0px; --header-height: 64px; --header-mb: 0px; --avatar-image-transform: translate3d(0rem, 0, 0) scale(1); --avatar-border-transform: translate3d(-0.2222222222222222rem, 0, 0) scale(1.7777777777777777); --avatar-border-opacity: 0; --header-top: 0px; --avatar-top: 0px;" lang="en">
  <head>
  <meta charset="utf-8">

  
    <title>Matt Sears | Scaling Ruby on Rails Apps with Kubernetes</title>
  
  <link rel="icon" href="/assets/images/me.png" type="image/x-icon" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open Sans">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <script src="/assets/builds/application.js"></script>
  <link href="/assets/builds/application.css" rel="stylesheet" type="text/css" media="all" />
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Scaling Ruby on Rails Apps with Kubernetes | Matt Sears</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Scaling Ruby on Rails Apps with Kubernetes" />
<meta name="author" content="Matt Sears" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In the second part of this series, we have a working Rails application up and running in our cluster with a load balancer to boot. In this post, we’re going to explore how to scale and manage our Rails application running in our cluster." />
<meta property="og:description" content="In the second part of this series, we have a working Rails application up and running in our cluster with a load balancer to boot. In this post, we’re going to explore how to scale and manage our Rails application running in our cluster." />
<link rel="canonical" href="https://mattsears.com/articles/2020/04/03/scaling-ruby-on-rails-apps-with-kubernetes/" />
<meta property="og:url" content="https://mattsears.com/articles/2020/04/03/scaling-ruby-on-rails-apps-with-kubernetes/" />
<meta property="og:site_name" content="Matt Sears" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-03T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Scaling Ruby on Rails Apps with Kubernetes" />
<script type="application/ld+json">
{"description":"In the second part of this series, we have a working Rails application up and running in our cluster with a load balancer to boot. In this post, we’re going to explore how to scale and manage our Rails application running in our cluster.","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://mattsears.com/assets/images/me.png"},"name":"Matt Sears"},"url":"https://mattsears.com/articles/2020/04/03/scaling-ruby-on-rails-apps-with-kubernetes/","headline":"Scaling Ruby on Rails Apps with Kubernetes","dateModified":"2020-04-03T00:00:00+00:00","datePublished":"2020-04-03T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mattsears.com/articles/2020/04/03/scaling-ruby-on-rails-apps-with-kubernetes/"},"author":{"@type":"Person","name":"Matt Sears"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body class="flex h-full flex-col bg-zinc-50 dark:bg-black">
    <div id="__next">
      <div class="fixed inset-0 flex justify-center sm:px-8">
        <div class="flex w-full max-w-7xl lg:px-8">
          <div class="w-full bg-white ring-1 ring-zinc-100 dark:bg-zinc-900 dark:ring-zinc-300/20"></div>
        </div>
      </div>
      <div class="relative">
        <header class="pointer-events-none relative z-50 flex flex-col" style="height: 64px;">
  <div class="top-0 z-10 h-16 pt-6" style="position:var(--header-position)">
    <div class="sm:px-8 top-[var(--header-top,theme(spacing.6))] w-full" style="position:var(--header-inner-position)">
      <div class="mx-auto max-w-7xl lg:px-8">
        <div class="relative px-4 sm:px-8 lg:px-12">
          <div class="mx-auto max-w-2xl lg:max-w-5xl">
            <div class="relative flex gap-4">
              <div class="flex flex-1">
                <div class="h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:ring-white/10"><a aria-label="Home" class="pointer-events-auto" href="/">
                  <img alt="" sizes="2.25rem" srcset="" src="/assets/images/me.png" decoding="async" data-nimg="future" class="rounded-full bg-zinc-100 object-cover dark:bg-zinc-800 h-9 w-9" style="color: transparent;" width="512" height="512"></a></div>
              </div>
              <div class="flex flex-1 justify-end md:justify-center">
                <div class="pointer-events-auto md:hidden" data-headlessui-state="">
                  <button class="group flex items-center rounded-full bg-white/90 px-4 py-2 text-sm font-medium text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:text-zinc-200 dark:ring-white/10 dark:hover:ring-white/20" id="headlessui-popover-button-:Rqb6:" type="button" aria-expanded="false" data-headlessui-state="">
                    Menu
                    <svg viewBox="0 0 8 6" aria-hidden="true" class="ml-3 h-auto w-2 stroke-zinc-500 group-hover:stroke-zinc-700 dark:group-hover:stroke-zinc-400">
                      <path d="M1.75 1.75 4 4.25l2.25-2.5" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                  </button>
                </div>
                
<nav class="pointer-events-auto hidden md:block">
  <ul class="flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:text-zinc-200 dark:ring-white/10">
    
    <li>
      <a class="relative block px-3 py-2 transition  hover:text-teal-500 dark:hover:text-teal-400  " href="/">
        Home
        
      </a>
    </li>
    
    <li>
      <a class="relative block px-3 py-2 transition  hover:text-teal-500 dark:hover:text-teal-400  " href="/about/">
        About
        
      </a>
    </li>
    
    <li>
      <a class="relative block px-3 py-2 transition  hover:text-teal-500 dark:hover:text-teal-400  " href="/articles/">
        Journal
        
      </a>
    </li>
    
    <li>
      <a class="relative block px-3 py-2 transition hover:text-teal-500 dark:hover:text-teal-400 " href="#contact" data-name="matt" data-domain="mattsears" data-tld="com" onclick="window.location.href = 'mailto:' + this.dataset.name + '@' + this.dataset.domain + '.' + this.dataset.tld; return false;">Contact </a>
    </li>
  </ul>

</nav>



              </div>
              <div class="flex justify-end md:flex-1 ">
                <div class="pointer-events-auto ">
                  <button type="button"
                          aria-label="Toggle dark mode"
                          data-controller='toggle-mode'
                          data-action='click->toggle-mode#toggleMode'
                          class="group rounded-full bg-white/90 px-3 py-2 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur transition dark:bg-zinc-800/90 dark:ring-white/10 dark:hover:ring-white/20">
                    <svg viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="h-6 w-6 fill-zinc-100 stroke-zinc-500 transition group-hover:fill-zinc-200 group-hover:stroke-zinc-700 dark:hidden [@media(prefers-color-scheme:dark)]:fill-teal-50 [@media(prefers-color-scheme:dark)]:stroke-teal-500 [@media(prefers-color-scheme:dark)]:group-hover:fill-teal-50 [@media(prefers-color-scheme:dark)]:group-hover:stroke-teal-600">
                      <path d="M8 12.25A4.25 4.25 0 0 1 12.25 8v0a4.25 4.25 0 0 1 4.25 4.25v0a4.25 4.25 0 0 1-4.25 4.25v0A4.25 4.25 0 0 1 8 12.25v0Z"></path>
                      <path d="M12.25 3v1.5M21.5 12.25H20M18.791 18.791l-1.06-1.06M18.791 5.709l-1.06 1.06M12.25 20v1.5M4.5 12.25H3M6.77 6.77 5.709 5.709M6.77 17.73l-1.061 1.061" fill="none"></path>
                    </svg>
                    <svg viewBox="0 0 24 24" aria-hidden="true" class="hidden h-6 w-6 fill-zinc-700 stroke-zinc-500 transition dark:block [@media(prefers-color-scheme:dark)]:group-hover:stroke-zinc-400 [@media_not_(prefers-color-scheme:dark)]:fill-teal-400/10 [@media_not_(prefers-color-scheme:dark)]:stroke-teal-500">
                      <path d="M17.25 16.22a6.937 6.937 0 0 1-9.47-9.47 7.451 7.451 0 1 0 9.47 9.47ZM12.75 7C17 7 17 2.75 17 2.75S17 7 21.25 7C17 7 17 11.25 17 11.25S17 7 12.75 7Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

        <main>
          <div class="sm:px-8 mt-16 lg:mt-32">
            <div class="mx-auto max-w-7xl lg:px-8">
              <div class="relative px-4 sm:px-8 lg:px-12">
                <div class="mx-auto max-w-2xl lg:max-w-5xl">
                  <div class="xl:relative">
                    <div class="mx-auto max-w-3xl">
                      
                      <a type="button" href="/articles/2020/04/08/deploying-ruby-on-rails-apps-on-kubernetes/" aria-label="Go back to articles" class=" group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10 dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-left-5 lg:mb-0 lg:-mt-2 xl:-top-1.5 xl:left-0 xl:mt-0">

                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4 stroke-zinc-500 transition group-hover:stroke-zinc-700 dark:stroke-zinc-500 dark:group-hover:stroke-zinc-400">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15m0 0l6.75 6.75M4.5 12l6.75-6.75" />
                        </svg>
                      </a>
                      

                      
                      <a type="button" href="/articles/2019/08/10/quick-wins-to-improve-rails-performance/" aria-label="" class="group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10 dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-right-5 lg:mb-0 lg:-mt-2 xl:-top-1.5 xl:right-0 xl:mt-0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4 stroke-zinc-500 transition group-hover:stroke-zinc-700 dark:stroke-zinc-500 dark:group-hover:stroke-zinc-400">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" />
                        </svg>
                      </a>
                      


                      <article>
                        <header class="flex flex-col">
                          <h1 class="mt-6 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-4xl">
                            Scaling Ruby on Rails Apps with Kubernetes
                          </h1>
                          <time datetime="2020-04-03" class="order-first flex items-center text-base text-zinc-400 dark:text-zinc-500">
                            <span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
                            <span class="ml-3">April 03, 2020 </span>
                          </time>
                        </header>
                        <div class="mt-8 prose dark:prose-invert">
                          <p>In the <a href="/articles/2020/04/08/deploying-ruby-on-rails-apps-on-kubernetes">second</a> part of this series, we have a working
Rails application up and running in our cluster with a load balancer to boot. In
this post, we’re going to explore how to scale and manage our Rails application
running in our cluster.<!--more--></p>

<h3 id="scaling-up">Scaling up</h3>

<p>This is where things really pay off. Scaling up (and down) has never been
easier. We can add new instances (Pods) of our application with a single command
<code class="language-plaintext highlighter-rouge">kubectl scale</code>. Let’s add a new task to our <code class="language-plaintext highlighter-rouge">kube.rake</code> that will take one
argument for the number of servers we want to run.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">desc</span> <span class="s2">"Set the number of instances to run in the cluster"</span>
<span class="n">task</span> <span class="ss">:scale</span><span class="p">,</span> <span class="p">[</span><span class="ss">:count</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:environment</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
  <span class="n">kubectl</span> <span class="s2">"scale deployments/myapp-deployment --replicas </span><span class="si">#{</span><span class="n">args</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s say we’re expecting a big rush of sales this weekend and we need some
extra horsepower to handle the requests. Let’s scale our servers to five instead
of two. Very cool!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$rake</span> kube:scale[5]
deployment.apps/myapp-deployment scaled

<span class="nv">$rake</span> kube:list
...
default         myapp-deployment-644fcb756b-j94f2        1/1     Running   0          9s
default         myapp-deployment-644fcb756b-lnvjn        1/1     Running   0          2d19h
default         myapp-deployment-644fcb756b-pfcsj        1/1     Running   0          9s
default         myapp-deployment-644fcb756b-q6fbg        1/1     Running   0          9s
default         myapp-deployment-644fcb756b-smrjw        1/1     Running   0          2d19h
...
</code></pre></div></div>

<p>And we have three new instances running bring the total to five. And we can easily scale back down with <code class="language-plaintext highlighter-rouge">rake kube:scale[2]</code>.</p>

<h3 id="scaling-on-autopilot">Scaling on Autopilot</h3>

<p>What if we don’t want to scale manually? Kubernetes makes autoscaling very
simple. We can add a
<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">HorizontalPodAutoscaler</a>
that will continously check the server stats and determine if it needs more pods
running.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># ./kube/autoscaler.yml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling/v2beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HorizontalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">scaleTargetRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-deployment</span>
  <span class="na">minReplicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">maxReplicas</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">metrics</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Resource</span>
    <span class="na">resource</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">cpu</span>
      <span class="na">target</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">Utilization</span>
        <span class="na">averageUtilization</span><span class="pi">:</span> <span class="m">70</span>
</code></pre></div></div>

<p>From now on, anytime the CPU reaches 70% utilization on average, our cluster
will spin up new pods automatically. Set it and forget it.</p>

<h3 id="executing-tasks-with-jobs">Executing tasks with Jobs</h3>

<p>Kubernete has a built-in way to execute a command via a
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/">Job</a>. A
job in Kubernetes is a supervisor for pods carrying out batch processes, that
is, a process that runs for a certain time to completion. In our case, we’re
going to run database migrations via a Job. Let’s create new configuration for
our migration job:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">migrate</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
    <span class="na">tier</span><span class="pi">:</span> <span class="s">app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ttlSecondsAfterFinished</span><span class="pi">:</span> <span class="m">100</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
      <span class="na">imagePullSecrets</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">regcred</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">littlelines/myapp:build</span>
          <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
          <span class="na">command</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">bundle</span>
            <span class="pi">-</span> <span class="s">exec</span>
            <span class="pi">-</span> <span class="s">rake</span>
            <span class="pi">-</span> <span class="s">db:migrate</span>
          <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SECRET_KEY_BASE</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$SECRET_KEY_BASE'</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RAILS_ENV</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$RAILS_ENV'</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DATABASE_USERNAME</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$DATABASE_USERNAME'</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DATABASE_PASSWORD</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$DATABASE_PASSWORD'</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DATABASE_HOST</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$DATABASE_HOST'</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DATABASE_PORT</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$DATABASE_PORT'</span>
</code></pre></div></div>

<p>This looks very similar to our depoyment configuration. That’s because we need
to do a lot of similar things to get the application up and running. The most
interesting piece in our Job configuration is the <code class="language-plaintext highlighter-rouge">command</code> block. As you can
see, this how we tell Kubernetes to run our database migrations. Let’s add a new
task to our <a href="https://gist.github.com/mattsears/9a5ab09a3ca7861c3daa0d24ca335fed">Rake file</a> for running the migration job.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">desc</span> <span class="s2">"Migrates the Rails database"</span>
<span class="n">task</span> <span class="ss">:migrate</span> <span class="k">do</span>
  <span class="n">apply</span> <span class="s2">"kube/job-migrate.yml"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, let’s run it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake kube:migrate
job.batch/migrate created
</code></pre></div></div>

<p>What happens is kubernetes will create a new pod, pull our docker image down,
and run our rails migration command. When a Job completes, they aren’t deleted
right away. They’re kept around so we can still check the logs for errors,
warnings, or other diagnostic output. Since we have <code class="language-plaintext highlighter-rouge">ttlSecondsAfterFinished</code>
set to 100 in our job file, the pod will be eligible to be automatically
deleted, 100 seconds after it finishes.</p>

<h3 id="inspect-log-files-in-production">Inspect log files in production</h3>

<p>Probably the most common way to debug production issues is looking at the log
files for exceptions. Things are a little complicated now since we have the
application running on multiple instances. In our case, it’s most likely something
that our Rails app is needing that we haven’t addressed such as connection
issues with the database, missing environment variables, etc.</p>

<p>Luckily for us, Kubernetes collects logs from Pods by monitoring their STDOUT
and STDERR streams. Since Rails 5, we can log to STDOUT in production
environment through introduction of new environment variable
RAILS_LOG_TO_STDOUT. If you recall from our <code class="language-plaintext highlighter-rouge">deployment.yml</code>, we have the
environment variable RAILS_LOG_TO_STDOUT set to true. By setting
RAILS_LOG_TO_STDOUT to any value we should have the production logs directed to
STDOUT. Let’s go back to your <a href="https://gist.github.com/mattsears/9a5ab09a3ca7861c3daa0d24ca335fed">Rake file</a> and add a new task:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">desc</span> <span class="s2">"Tail log files from our app running in the cluster"</span>
<span class="n">task</span> <span class="ss">:logs</span> <span class="k">do</span>
  <span class="nb">exec</span> <span class="s1">'kubectl logs -f -l app=myapp --all-containers'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note, we’re using the <code class="language-plaintext highlighter-rouge">exec</code> because it will replace the current process and can
capture STDOUT allowing us to view the logs in real-time. Now we can run
<code class="language-plaintext highlighter-rouge">kube:logs</code> and it will print the last few lines of all the Rails applications
running in the cluster. Since we have two pods running, we specify the app name,
<code class="language-plaintext highlighter-rouge">myapp</code> in this case, so Kubernetes knows to get all the log files matching that
app name.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake kube:logs

* Version 2.9.0 (ruby 2.4.6)
* Min threads: 5, max threads: 5
* Environment: production
* Listening on tcp://0.0.0.0:3000
</code></pre></div></div>

<p>This is very handy since we can now see what’s going on in the Pods!</p>

<h3 id="logging-into-the-pod">Logging into the Pod</h3>

<p>When production issues happen or when we’re first setting up our infrastructure,
I often want to login into the server and run a few commands either for
diagnostics or to fix the issue to get the application running again. The big
question here is, since we have multiple pods running our application, how to
log into them? Well, you can’t log into all of them, but you can log into one of
them and since the pods are running the identical Rails application, any one of
them will do. No surprise here, we want to write a rake task to help us with
this because, we’re going to need to log into the server multiple times
throughout the lifespan of the application.</p>

<p>First, we need to find a Pod run our Rails application to work with. Pod names
change every time we deploy so we can’t hard code the pod name. Let’s create a
method in our <a href="https://gist.github.com/mattsears/9a5ab09a3ca7861c3daa0d24ca335fed">Rake file</a> called <code class="language-plaintext highlighter-rouge">find_first_pod_name</code> that will find the pod name.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find_first_pod_name</span>
  <span class="sb">`kubectl get pods|grep myapp-deployment|awk '{print $1}'|head -n 1`</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">strip</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This method calls <code class="language-plaintext highlighter-rouge">kubectl get pods</code> that returns a list of pods running in the
cluster and filters the list that matches those running our application i.e <code class="language-plaintext highlighter-rouge">myapp-deployment</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get pods

NAMESPACE       NAME                                        READY   STATUS
cert-manager    cert-manager-57cdd66b-vvwjj                 1/1     Running
cert-manager    cert-manager-cainjector-79f4496665-tdmxj    1/1     Running
cert-manager    cert-manager-webhook-6d57dbf4f-r9brk        1/1     Running
default         myapp-deployment-644fcb756b-lnvjn           1/1     Running
default         myapp-deployment-644fcb756b-smrjw           1/1     Running
ingress-nginx   nginx-ingress-controller-7f74f657bd-96ghr   1/1     Running
</code></pre></div></div>

<p>Running <code class="language-plaintext highlighter-rouge">find_first_pod_name</code> will return <code class="language-plaintext highlighter-rouge">myapp-deployment-644fcb756b-lnvjn</code> as
the result and that’s all we need. Let’s put it use in the new <code class="language-plaintext highlighter-rouge">shell</code> task:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">desc</span> <span class="s2">"Open a session to a pod on the cluster"</span>
<span class="n">task</span> <span class="ss">:shell</span> <span class="k">do</span>
  <span class="nb">exec</span> <span class="s2">"kubectl exec -it </span><span class="si">#{</span><span class="n">find_first_pod_name</span><span class="si">}</span><span class="s2"> bash"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Here we’re again using Kubernetes’ <code class="language-plaintext highlighter-rouge">exec</code> and Ruby’s <code class="language-plaintext highlighter-rouge">exec</code> to run a command on
pod that will replace our current process running. In this case, we’re calling
<code class="language-plaintext highlighter-rouge">bash</code> to give us a unix shell on the pod. This command will take us right to
the root of our Rails application running on the pod.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake kube:shell

root@myapp-deployment-644fcb756b-lnvjn:/app# ls -l
total 92
-rw-r--r--  1 root root 2064 Apr 1 23:45 Dockerfile
-rw-r--r--  1 root root 1699 Apr 1 23:45 Gemfile
-rw-r--r--  1 root root 9431 Apr 1 23:45 Gemfile.lock
-rw-r--r--  1 root root 3841 Apr 1 23:45 README.md
-rw-r--r--  1 root root  273 Apr 1 23:45 Rakefile
drwxr-xr-x 10 root root 4096 Apr 1 23:45 app
drwxr-xr-x  6 root root 4096 Apr 1 23:45 config
-rw-r--r--  1 root root  158 Apr 1 23:45 config.ru
drwxr-xr-x  3 root root 4096 Apr 1 23:45 db
drwxr-xr-x  2 root root 4096 Apr 1 23:45 doc
drwxr-xr-x  2 root root 4096 Apr 1 23:45 kube
drwxr-xr-x  4 root root 4096 Apr 1 23:45 lib
drwxr-xr-x  1 root root 4096 Apr 1 00:18 log
drwxr-xr-x  1 root root 4096 Apr 1 23:49 public
drwxr-xr-x  5 root root 4096 Apr 1 23:45 script
drwxr-xr-x  5 root root 4096 Apr 1 23:45 test
drwxr-xr-x  1 root root 4096 Apr 1 23:49 tmp
drwxr-xr-x  5 root root 4096 Apr 1 23:46 vendor
</code></pre></div></div>

<p>How cool is that!? With the combination of Kubernetes’ <code class="language-plaintext highlighter-rouge">exec</code> and Ruby’s <code class="language-plaintext highlighter-rouge">exec</code> and our <code class="language-plaintext highlighter-rouge">find_first_pod_name</code> method, we can add many helpful tasks that we can run anytime on our application.</p>

<h3 id="more-miscellaneous-and-helpful-tasks">More miscellaneous and helpful tasks</h3>

<p>I want to round out this post with a few more rake tasks to give you a better
idea on how we can expand on the work we’ve already done.</p>

<p>Run any command on a pod with the <code class="language-plaintext highlighter-rouge">run</code> task:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>desc <span class="s2">"Runs a command in the server"</span>
task :run, <span class="o">[</span>:command] <span class="o">=&gt;</span> <span class="o">[</span>:environment] <span class="k">do</span> |t, args|
   kubectl <span class="s2">"exec -it #{find_first_pod_name} echo </span><span class="si">$(</span><span class="c">#{args[:command]})"</span>
end

<span class="nv">$ </span>rake kube:run[<span class="s1">'bundle exec rake sales_report:deliver'</span><span class="o">]</span>
Sales Report Sent!
</code></pre></div></div>

<p>Open a rails console session on a production rails application:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>desc <span class="s2">"Run rails console on a pod"</span>
task :console <span class="k">do
  </span>system <span class="s2">"kubectl exec -it #{find_first_pod_name} bundle exec rails console"</span>
end

<span class="nv">$ </span>rake kube:console
Loading production environment <span class="o">(</span>Rails 5.2.2<span class="o">)</span>
irb<span class="o">(</span>main<span class="o">)</span>:001:0&gt; User.count
  <span class="o">(</span>2.3ms<span class="o">)</span>  SELECT COUNT<span class="o">(</span><span class="k">*</span><span class="o">)</span> FROM <span class="s2">"users"</span>
<span class="o">=&gt;</span> 1
</code></pre></div></div>

<p>Print all the environment variables on our production application sorted alphabetically:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>desc <span class="s2">"Print the environment variables"</span>
task :config <span class="k">do
  </span>system <span class="s2">"kubectl exec -it #{find_first_pod_name} printenv | sort"</span>
end

<span class="nv">$ </span>rake kube:config
<span class="nv">AWS_ACCESS_KEY</span><span class="o">=</span>AKIXXXXXXXXXXXXXXXXXXXXX
<span class="nv">AWS_REGION</span><span class="o">=</span>us-east-2
<span class="nv">AWS_S3_BUCKET</span><span class="o">=</span>myapp-bucket
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>+j1XXXXXXXXXXXXXX
...
</code></pre></div></div>

<p>Get the idea? Let’s take one final look at the tasks we created with our rake file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake <span class="nt">-T</span> | <span class="nb">grep </span>kube
rake kube:config                    <span class="c"># Print the environment variables</span>
rake kube:console                   <span class="c"># Run rails console on a pod</span>
rake kube:deploy                    <span class="c"># Rollout a new deployment</span>
rake kube:list                      <span class="c"># Print useful information aout our Kubernete setup</span>
rake kube:logs                      <span class="c"># Tail log from server</span>
rake kube:migrate                   <span class="c"># Migrates the Rails database</span>
rake kube:run[command]              <span class="c"># Runs a command in the server</span>
rake kube:scale[count]              <span class="c"># Set the number of instances to run in the cluster</span>
rake kube:setup                     <span class="c"># Apply our Kubernete configurations to our cluster</span>
rake kube:shell                     <span class="c"># Open a session to a pod on the cluster</span>
</code></pre></div></div>

<p>If you familar with Heroku, Capistrano, or Mina, some of these commands may look
familiar to you. By combining Ruby on Rails, Kubernetes and Rake, I hope I’ve
been able to illustrate how we can setup, deploy, and scale our Rails
application running on Kubernetes using the tools we’re already familiar with.</p>

                        </div>
                      </article>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
        
<footer class="mt-24">
  <div class="sm:px-8">
    <div class="mx-auto max-w-7xl lg:px-8">
      <div class="border-t border-zinc-100 pt-10 pb-16 dark:border-zinc-700/40">
        <div class="relative px-4 sm:px-8 lg:px-12">
          <div class="mx-auto max-w-2xl lg:max-w-5xl">
            <div class="flex flex-col items-center justify-between gap-6 sm:flex-row">
              <div class="flex gap-6 text-sm font-medium text-zinc-800 dark:text-zinc-200">
                <a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/">Home</a>
                <a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/about">About</a>
                <a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/work">Work</a>
                <a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/articles">Journal</a>
              </div>
              <p class="text-sm text-zinc-400 dark:text-zinc-500">
                © 2023 Matt Sears. All rights reserved.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

      </div>
    </div>
  </body>
</html>
