<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]> ><! <![endif]-->
<html class='no-js' lang='en'>
  <!-- <![endif] -->
  <head>
    <meta charset='utf-8' />
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <title>Matt Sears | Relay outbound SMTP email to Gmail</title>
    <meta content='Matt Sears, Matt, Sears' name='keywords' />
    <meta author='Matt Sears' />
    <link href='http://feeds.feedburner.com/mattsears' rel='alternate' title='Feed for mattsears' type='application/atom+xml' />
    <link href='/images/favicon.png' rel='shortcut icon' />
    <link href='/fonts/ss-social.css' rel='stylesheet' />
    <link href="/stylesheets/app.css?1357089829" media="screen" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav>
      <div class='row'></div>
    </nav>
    <div class='row'>
      <div class='twelve columns centered'>
        <div class='row'>
  <div class='seven columns centered'>
    <header class='text-center'>
      <a href='/'>
        <img class='me' height='100' src='/images/matt-sears.png' width='100' />
      </a>
      <h3>
        Matt Sears
      </h3>
    </header>
  </div>
</div>
<div class='row'>
  <div class='ten column centered'>
    <article>
      <header class='text-center'>
        <h2>
          <a href='/articles/2008/08/01/relay-outbound-smtp-email-to-gmail'>
            Relay outbound SMTP email to Gmail
          </a>
        </h2>
        <h5>
          Written by
          <a href='#'>Matt</a>
          on
          /
          Aug  1
        </h5>
      </header>
      <div class='row'>
        <div class='ten column centered'>
          <p>Sending emails with Rails via Gmail is a snap with Marc Chung&#39;s excellent plugin <a href="http://code.openrain.com/rails/action_mailer_tls">action_mailer_tls</a>. However, sometimes our production environment isn&#39;t using Gmail as a mail server and/or we just need an easy way to send email from our development environment for testing or demonstrating purposes.</p>

<p>Instead of installing the action_mailer_tls plugin and configuring each of our Rails apps, we can do a one-time setup of our local Postfix client to relay all SMTP outbound emails to our Gmail account. If your running a Mac OS Leopard or Linux, Postfix should already be installed. With a little configuration, we should be up and running in a couple minutes.</p>

<p>First create /etc/postfix/relay_password file with the server name, email account name and password as shown below. This configuration works with Gmail accounts as well as with Google Apps email accounts. I&#39;m personally using my company&#39;s Google Apps with a special email account setup for outbound emails only.</p>
<div class="highlight"><pre><span class="n">smtp</span><span class="p">.</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span>    <span class="n">example</span><span class="p">@</span><span class="n">yourdomain</span><span class="p">.</span><span class="n">com</span><span class="p">:</span><span class="n">yourpassword</span>
</pre></div>
<p>Then tell Postfix about our google accounts information so it knows how and where to relay the email to. This can be done with the postmap command:</p>
<div class="highlight"><pre>$ <span class="n">postmap</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">relay_password</span>
</pre></div>
<p>Since Gmail requires a TLS (Transport Layer Security) connection for certificate-based authentication, we&#39;ll need to download a free root certificate from Verisign <a href="https://www.verisign.com/support/roots.html" rel="external"><a href="https://www.verisign.com/support/roots.html">https://www.verisign.com/support/roots.html</a></a> to authenticate our remote SMTP client.</p>
<div class="highlight"><pre>$ <span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">certs</span>
$ <span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">certs</span>
$ <span class="n">sudo</span> <span class="n">cp</span> <span class="n">roots</span><span class="p">.</span><span class="n">zip</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">certs</span>
$ <span class="n">sudo</span> <span class="n">unzip</span> <span class="o">-</span><span class="nb">j</span> <span class="n">roots</span><span class="p">.</span><span class="n">zip</span>
$ <span class="n">sudo</span> <span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="n">inform</span> <span class="n">der</span> <span class="o">-</span><span class="n">in</span> <span class="n">ThawtePremiumServerCA</span><span class="p">.</span><span class="n">cer</span> <span class="o">-</span><span class="n">out</span>  <span class="n">ThawtePremiumServerCA</span><span class="p">.</span><span class="n">pem</span>
$ <span class="n">sudo</span> <span class="n">c_rehash</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">certs</span>
</pre></div>
<p>Now we are ready to configure Postfix. Postfix needs to know what host to relay the email to, the username and password to authenticate the Gmail account, and the path to our certificates for the encrypted session.  Add these lines to the bottom of /etc/postfix/main.cf</p>
<div class="highlight"><pre><span class="n">relayhost</span> <span class="p">=</span> <span class="n">smtp</span><span class="p">.</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="p">:</span>587
# <span class="n">auth</span>
<span class="n">smtp_sasl_auth_enable</span> <span class="p">=</span> <span class="n">yes</span>
<span class="n">smtp_sasl_password_maps</span> <span class="p">=</span> <span class="n">hash</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">relay_password</span>
<span class="n">smtp_sasl_security_options</span> <span class="p">=</span> <span class="n">noanonymous</span>

# <span class="n">tls</span>
<span class="n">smtp_tls_security_level</span> <span class="p">=</span> <span class="n">may</span>
<span class="n">smtp_tls_CApath</span> <span class="p">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">certs</span>
<span class="n">smtp_tls_session_cache_database</span> <span class="p">=</span> <span class="n">btree</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">smtp_scache</span>
<span class="n">smtp_tls_session_cache_timeout</span> <span class="p">=</span> 3600<span class="n">s</span>
<span class="n">smtp_tls_loglevel</span> <span class="p">=</span> 1
<span class="n">tls_random_source</span> <span class="p">=</span> <span class="n">dev</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">urandom</span>
</pre></div>
<p>Restart (or start) Postfix to pick up our new changes.</p>
<div class="highlight"><pre>$ <span class="n">sudo</span> <span class="n">postfix</span> <span class="n">stop</span>
$ <span class="n">sudo</span> <span class="n">postfix</span> <span class="n">start</span>
</pre></div>
<p>That&#39;s it! Now we don&#39;t have to do any special installation or configuration to send email via Gmail for our Rails apps. We just need to set the delivery method to :smtp and we&#39;re ready to go.</p>
          <hr />
        </div>
      </div>
    </article>
  </div>
</div>
<div class='row ten columns centered paginator'>
  <div class='row three columns'>
  </div>
  <div class='row three columns text-right'>
    <a href="/articles/p3">Newer posts →</a>
  </div>
</div>
        <section class='explore'>
          <div class='row'>
            <div class='ten columns centered'>
              <h5 class='text-center capitalize'>
                Explore articles from my blog
              </h5>
            </div>
          </div>
          <div class='row categories'>
            <div class='six columns text-center centered'>
              <ul class='no-bullet'>
                <li>
                  <a href='/articles/tags/git'>
                    Git
                  </a>
                </li>
                <li>
                  <a href='/articles/tags/ruby'>
                    Ruby
                  </a>
                </li>
                <li>
                  <a href='/articles/tags/clojure'>
                    Clojure
                  </a>
                </li>
                <li>
                  <a href='/articles/tags/rspec'>
                    Rspec
                  </a>
                </li>
                <li>
                  <a href='/articles/tags/minitest'>
                    Minitest
                  </a>
                </li>
                <li>
                  <a href='/articles'>Everything</a>
                </li>
              </ul>
            </div>
          </div>
          <div class='row'>
            <div class='six columns centered'>
              <form action='http://google.com/search' method='get'>
                <fieldset role='search'>
                  <input name='q' type='hidden' value='site:mattsears.com' />
                  <input class='search' name='q' placeholder='... or search this site (via Google)' results='0' type='text' />
                </fieldset>
              </form>
            </div>
          </div>
        </section>
        <section class='browse'>
          <div class='row'>
            <div class='ten columns centered'>
              <div class='row'>
                <div class='six mobile-four columns'>
                  <h5>
                    <b>
                      Popular:
                    </b>
                    The most visited articles:
                  </h5>
                  <hr />
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/12/10/minitest-quick-reference'>
                        Minitest Quick Reference
                      </a>
                    </div>
                  </div>
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/11/16/nyan-cat-rspec-formatter'>
                        Nyan Cat RSpec Formatter
                      </a>
                    </div>
                  </div>
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks'>
                        Ruby Blocks as Dynamic Callbacks
                      </a>
                    </div>
                  </div>
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2009/06/06/20-clojure-links-to-get-you-up-to-speed'>
                        20 Clojure Links To Get You Up To Speed
                      </a>
                    </div>
                  </div>
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/10/12/gaga-key-value-store'>
                        Gaga, A Git-Backed Key/Value Store
                      </a>
                    </div>
                  </div>
                </div>
                <div class='six mobile-four columns'>
                  <h5>
                    <b>
                      New:
                    </b>
                    My most recent articles:
                  </h5>
                  <hr />
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/12/10/minitest-quick-reference'>
                        Minitest Quick Reference
                      </a>
                    </div>
                  </div>
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks'>
                        Ruby Blocks as Dynamic Callbacks
                      </a>
                    </div>
                  </div>
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/11/16/nyan-cat-rspec-formatter'>
                        Nyan Cat RSpec Formatter
                      </a>
                    </div>
                  </div>
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/10/12/gaga-key-value-store'>
                        Gaga, A Git-Backed Key/Value Store
                      </a>
                    </div>
                  </div>
                  <hr />
                  <div class='row'>
                    <div class='nine columns cell'>
                      <a href='/articles/2011/05/15/print-stamps-with-ruby'>
                        Print Stamps With Ruby!
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <footer class='row text-center'>
          <div class='twelve columns'>
            <div class='row'>
              <div class='twelve columns'>
                <p>
                  You should follow me on
                  <a href='https://twitter.com/mattsears' rel='external'>Twitter</a>
                  and subscribe to
                  my
                  <a href='http://feeds.feedburner.com/mattsears'>RSS</a>
                  feed. Trust me.
                  <br />
                  Copyright © 2012 Matt Sears.
                </p>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        //
          var _gauges = _gauges || [];
          (function() {
            var t   = document.createElement('script');
            t.type  = 'text/javascript';
            t.async = true;
            t.id    = 'gauges-tracker';
            t.setAttribute('data-site-id', '4fb913d1f5a1f50be2000073');
            t.src = '//secure.gaug.es/track.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(t, s);
          })();
        //
      //]]>
    </script>
    <script src="/javascripts/all.js?1357090071" type="text/javascript"></script>
  </body>
</html>
